[gd_scene load_steps=16 format=3 uid="uid://d3fi1rs02875v"]

[ext_resource type="Texture2D" uid="uid://b3n7pp1ivgmh0" path="res://assets/characters/Rock3_Idle (22x18).png" id="1_ir5p4"]

[sub_resource type="GDScript" id="GDScript_pg5ed"]
script/source = "extends CharacterBody2D

@export var speed: float = 80.0  # Walking speed
@export var gravity: float = 500.0  # Gravity force
@export var jump_force: float = -360.0  # Jump force (Negative because Y is inverted in Godot)
@export var chase_distance: float = 2000.0  # Maximum distance at which the enemy will start chasing the player
@export var proximity_distance: float = 500.0  # Distance to check for the player being \"next to\" the enemy
@export var random_move_interval: float = 2.0  # Time before random movement direction changes
@export var highest_floor_y: float = 100.0  # Y position of the highest floor (adjust accordingly)

var player: Node2D = null  # Reference to player
var random_direction: Vector2 = Vector2.ZERO  # Direction to move randomly
var random_move_timer: float = 0  # Timer to change random direction

func _ready():
	add_to_group(\"Enemy\")
	player = get_tree().get_first_node_in_group(\"Player\")  # Find the player node
	if player:
		random_direction = Vector2(randf_range(-1, 1), 0).normalized()

	self.collision_layer = 2  # Enemy layer (Layer 2)
	self.collision_mask = 1  # Mask to avoid collisions with other enemies (Mask 1)

func _process(delta):
	if player:
		var distance_to_player = global_position.distance_to(player.global_position)
		
		if distance_to_player < chase_distance and abs(player.global_position.x - global_position.x) <= proximity_distance and player.global_position.y < global_position.y:
			_chase_player(delta)
		else:
			_random_movement(delta)

func _random_movement(delta):
	random_move_timer += delta
	if random_move_timer >= random_move_interval:
		random_direction = Vector2(randf_range(-1, 1), randf_range(-1, 1)).normalized()
		random_move_timer = 0

	velocity.x = random_direction.x * speed
	velocity.y += gravity * delta
	move_and_slide()

func _chase_player(delta):
	var direction_to_player = (player.global_position - global_position).normalized()
	velocity.x = direction_to_player.x * speed

	# Prevent jumping if already on the highest floor
	if global_position.y > highest_floor_y and player.global_position.y < global_position.y - 10 and is_on_floor():
		velocity.y = jump_force

	velocity.y += gravity * delta
	move_and_slide()
"

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_bfein"]
radius = 16.0
height = 38.0

[sub_resource type="AtlasTexture" id="AtlasTexture_kbl5k"]
atlas = ExtResource("1_ir5p4")
region = Rect2(0, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_n0jy2"]
atlas = ExtResource("1_ir5p4")
region = Rect2(22, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_sjs6n"]
atlas = ExtResource("1_ir5p4")
region = Rect2(44, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_nennn"]
atlas = ExtResource("1_ir5p4")
region = Rect2(66, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_bpob2"]
atlas = ExtResource("1_ir5p4")
region = Rect2(88, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_rg1cv"]
atlas = ExtResource("1_ir5p4")
region = Rect2(110, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_lsbfq"]
atlas = ExtResource("1_ir5p4")
region = Rect2(132, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_chehr"]
atlas = ExtResource("1_ir5p4")
region = Rect2(154, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_xgjks"]
atlas = ExtResource("1_ir5p4")
region = Rect2(176, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_2sqbt"]
atlas = ExtResource("1_ir5p4")
region = Rect2(198, 0, 22, 18)

[sub_resource type="AtlasTexture" id="AtlasTexture_yfkrc"]
atlas = ExtResource("1_ir5p4")
region = Rect2(220, 0, 22, 18)

[sub_resource type="SpriteFrames" id="SpriteFrames_l8s8u"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_kbl5k")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_n0jy2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_sjs6n")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_nennn")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_bpob2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rg1cv")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_lsbfq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_chehr")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_xgjks")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_2sqbt")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_yfkrc")
}],
"loop": true,
"name": &"default",
"speed": 14.0
}]

[node name="enemy" type="CharacterBody2D" groups=["Enemy"]]
collision_layer = 2
script = SubResource("GDScript_pg5ed")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(13, 14)
rotation = -1.57079
shape = SubResource("CapsuleShape2D_bfein")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
texture_filter = 1
position = Vector2(13.4444, 11)
scale = Vector2(2.22222, 2.22222)
sprite_frames = SubResource("SpriteFrames_l8s8u")
autoplay = "default"
frame = 4
frame_progress = 0.166552
